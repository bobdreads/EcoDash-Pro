{% extends "_base.html" %}
{% load static %}

{% block title %}| Trades{% endblock title %}

{% block style %}
<style>
    .tag-pill {
        /* Você pode adicionar estilos extras aqui se o Tailwind não cobrir tudo */
    }
    .tag-pill .remove-tag {
        cursor: pointer;
    }
</style>
{% endblock style %}

{% block content %}
<div id="main-content" class="h-full w-full bg-gray-100 relative overflow-y-auto lg:ml-64">
    <main>
        <div class="pt-6 px-4">
            <div class="bg-white shadow rounded-lg p-4 sm:p-6 xl:p-8 ">
                <h3 class="text-xl font-semibold text-gray-900 mb-5">Registrar Novo Trade</h3>

                <form action="#" method="POST">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div>
                            <label for="conta" class="block mb-2 text-sm font-medium text-gray-900">Conta</label>
                            <select id="conta" name="conta" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5">
                                <option selected>Escolha uma conta</option>
                                <option value="CONTA1">Conta Principal</option>
                                <option value="CONTA2">Conta Secundária</option>
                                {# Adicione mais opções de conta conforme necessário #}
                            </select>
                        </div>

                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-900">Lado</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="compra" type="radio" value="COMPRA" name="lado" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 focus:ring-2">
                                    <label for="compra" class="ml-2 text-sm font-medium text-gray-900">Compra</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="venda" type="radio" value="VENDA" name="lado" class="w-4 h-4 text-pink-600 bg-gray-100 border-gray-300 focus:ring-pink-500 focus:ring-2">
                                    <label for="venda" class="ml-2 text-sm font-medium text-gray-900">Venda</label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="ativo" class="block mb-2 text-sm font-medium text-gray-900">Ativo</label>
                            <input type="text" name="ativo" id="ativo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" placeholder="Ex: PETR4, WINDFUT" required>
                        </div>

                        <div>
                            <label for="quantidade" class="block mb-2 text-sm font-medium text-gray-900">Quantidade</label>
                            <input type="number" name="quantidade" id="quantidade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" placeholder="Ex: 100" required>
                        </div>

                        <div>
                            <label for="data_trade" class="block mb-2 text-sm font-medium text-gray-900">Data</label>
                            <input type="date" name="data_trade" id="data_trade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" required>
                        </div>

                        <div>
                            <label for="horario_trade" class="block mb-2 text-sm font-medium text-gray-900">Horário</label>
                            <input type="time" name="horario_trade" id="horario_trade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" required>
                        </div>

                        <div>
                            <label for="preco" class="block mb-2 text-sm font-medium text-gray-900">Preço</label>
                            <input type="text" name="preco" id="preco" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" placeholder="Ex: 25,50" required>
                            {# Considere usar um input type="number" com step="0.01" para valores monetários #}
                        </div>

                        <div>
                            <label for="corretagem" class="block mb-2 text-sm font-medium text-gray-900">Corretagem</label>
                            <input type="text" name="corretagem" id="corretagem" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-600 focus:border-cyan-600 block w-full p-2.5" placeholder="Ex: 4,90">
                             {# Considere usar um input type="number" com step="0.01" para valores monetários #}
                        </div>

                        <div class="md:col-span-2">
                            <label for="anotacoes" class="block mb-2 text-sm font-medium text-gray-900">Anotações</label>
                            <textarea id="anotacoes" name="anotacoes" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-cyan-600 focus:border-cyan-600" placeholder="Detalhes sobre a operação, estratégia utilizada..."></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label for="tag-input" class="block mb-2 text-sm font-medium text-gray-900">Tags</label>
                            <div id="tag-container" class="flex flex-wrap items-center gap-2 p-2.5 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus-within:ring-cyan-600 focus-within:border-cyan-600">
                                {/* As pills vão aqui */}
                                <input type="text" id="tag-input" class="bg-transparent border-0 focus:ring-0 flex-grow p-0" placeholder="Adicione tags...">
                            </div>
                            <input type="hidden" name="tags_hidden" id="tags_hidden"> {/* Campo para enviar as tags */}
                            <p class="mt-1 text-xs text-gray-500">Pressione Enter ou vírgula para adicionar uma tag.</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="text-white bg-gradient-to-br from-pink-500 to-violet-500 hover:scale-[1.02] focus:ring-4 focus:outline-none focus:ring-cyan-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center shadow-md shadow-gray-300 transition-transform">
                            Salvar Trade
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>
{% endblock content %}

{% block script %}
{# Você pode adicionar scripts específicos para esta página aqui, se necessário #}
<script>
    // Pequeno script para garantir que a data não seja no futuro, se desejar.
    const dateInput = document.getElementById('data_trade');
    if (dateInput) {
        dateInput.max = new Date().toISOString().split("T")[0];
    }
    // Script para data máxima (opcional, como antes)
    const dateInput = document.getElementById('data_trade');
    if (dateInput) {
        dateInput.max = new Date().toISOString().split("T")[0];
    }

    // --- SCRIPT PARA TAGS "PILLS" ---
    const tagContainer = document.getElementById('tag-container');
    const tagInput = document.getElementById('tag-input');
    const tagsHiddenInput = document.getElementById('tags_hidden');
    let tags = [];

    // 1. Verificar se os elementos HTML foram encontrados corretamente
    console.log("Elemento tagContainer:", tagContainer);
    console.log("Elemento tagInput:", tagInput);
    console.log("Elemento tagsHiddenInput:", tagsHiddenInput);

    function updateTagsHiddenInput() {
        if (tagsHiddenInput) { // Adicionada verificação
            tagsHiddenInput.value = tags.join(',');
            console.log("Input Tags Hidden atualizado:", tagsHiddenInput.value);
        } else {
            console.error("ERRO: tagsHiddenInput não encontrado para atualizar!");
        }
    }

    function createTagPill(label) {
        console.log("2. Criando pill para:", label);
        const div = document.createElement('div');
        div.setAttribute('class', 'tag-pill bg-cyan-500 text-white text-xs font-semibold px-2.5 py-1 rounded-full flex items-center');
        
        const span = document.createElement('span');
        span.innerHTML = label;
        
        const closeIcon = document.createElement('span');
        closeIcon.innerHTML = '×'; // Um 'x' simples para remover
        // Adicionado cursor-pointer para melhor UX e verificação de tagInput
        closeIcon.setAttribute('class', 'remove-tag ml-2 text-sm hover:font-bold cursor-pointer'); 
        closeIcon.onclick = () => {
            console.log("Removendo tag:", label);
            const index = tags.indexOf(label);
            if (index > -1) {
                tags.splice(index, 1);
            }
            div.remove();
            updateTagsHiddenInput();
            if (tagInput) tagInput.focus(); // Volta o foco para o input, se existir
        };
        
        div.appendChild(span);
        div.appendChild(closeIcon);
        console.log("Pill HTML criada:", div);
        return div;
    }

    function addTag(label) {
        console.log("3. Função addTag chamada com:", label);
        const trimmedLabel = label.trim();
        if (trimmedLabel.length > 1 && !tags.includes(trimmedLabel)) { 
            tags.push(trimmedLabel);
            console.log("Tags no array:", tags);
            const pill = createTagPill(trimmedLabel);
            
            // 4. Verificando antes de inserir a pill
            if (tagContainer && tagInput && pill) {
                tagContainer.insertBefore(pill, tagInput);
                console.log("Pill inserida no container.");
            } else {
                // Mensagem de erro mais detalhada
                console.error("ERRO ao inserir pill! Elementos:", 
                    {isTagContainer: !!tagContainer, isTagInput: !!tagInput, isPill: !!pill}
                );
            }
            updateTagsHiddenInput();
        } else {
            console.log("Tag não adicionada (vazia, curta ou duplicada):", trimmedLabel);
        }
        if (tagInput) tagInput.value = ''; // Limpa o input, se existir
    }

    // 5. Verificando se o tagInput existe antes de adicionar listeners
    if (tagInput) {
        tagInput.addEventListener('keydown', function(event) {
            console.log("Evento keydown:", event.key);
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault(); 
                console.log("Enter ou vírgula pressionado.");
                addTag(tagInput.value);
            }
        });

        tagInput.addEventListener('blur', function() {
            console.log("Evento blur no tagInput.");
            if (tagInput.value.trim() !== '') {
                addTag(tagInput.value);
            }
        });
    } else {
        console.error("ERRO: tagInput não encontrado para adicionar listeners de evento!");
    }

    // 6. Verificando se o tagContainer existe antes de adicionar listener
    if (tagContainer) {
        tagContainer.addEventListener('click', (event) => {
            // Evitar que o clique no "x" de remover propague e foque o input desnecessariamente
            if (event.target.classList.contains('remove-tag')) {
                return;
            }
            console.log("Container da tag clicado.");
            if (tagInput) tagInput.focus();
        });
    } else {
        console.error("ERRO: tagContainer não encontrado para adicionar listener de clique!");
    }
</script>
{% endblock script %}